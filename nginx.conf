user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768;
    # multi_accept on;
}

# --- RTMP BLOCK: FOR STREAM INGEST AND HLS GENERATION ---
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        application live {
            live on;
            record off; # Keep this off for live streaming unless you want to record
            allow publish all;
            allow play all;

            # HLS GENERATION DIRECTIVES
            hls on;
            hls_path /var/www/html/hls; # This is where Nginx saves your HLS files
            hls_fragment 4s; # Duration of each HLS segment (e.g., 3 seconds)
            hls_playlist_length 60s; # Total duration of the playlist (e.g., 5 fragments * 3s)
            hls_sync 100ms; # Optional: Helps with live stream synchronization
            hls_cleanup on;

            # --- RTMP CALLBACKS: Auto-detect OBS connect/disconnect ---
            # When OBS connects, kill ffmpeg and go live
            on_publish http://127.0.0.1:5050/rtmp-publish;
            # When OBS disconnects, restart automated stream
            on_publish_done http://127.0.0.1:5050/rtmp-done;
        }
    }
}
# --- END RTMP BLOCK ---

http {
    ##
    # Basic Settings
    ##
    sendfile on;
    tcp_nopush on;
    types_hash_max_size 2048;
    # server_tokens off; # Keep this off for security
    # server_names_hash_bucket_size 64;
    # server_name_in_redirect off;

    include /etc/nginx/mime.types; # Include MIME types here
    default_type application/octet-stream;

    ##
    # SSL Settings (Global for HTTP block, but overridden by server blocks)
    ##
    # UPDATED SSL PROTOCOLS AND CIPHERS FOR BETTER COMPATIBILITY AND SECURITY
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    ##
    # Logging Settings
    ##
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Gzip Settings
    ##
    gzip on;
    # gzip_vary on;
    # gzip_proxied any;
    # gzip_comp_level 6;
    # gzip_buffers 16 8k;
    # gzip_http_version 1.1;
    # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    ##
    # Virtual Host Configs (Include only once inside http block)
    ##
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;

    # --- SERVER BLOCK: HTTP to HTTPS Redirect for all domains and IP ---
    server {
    if ($host = stream.ronautradio.la) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80;
        listen [::]:80;
        server_name ronautradio.la www.ronautradio.la stream.ronautradio.la 89.117.16.160; # Listen for both domains and IP

        # Let's Encrypt renewal path
        location /.well-known/acme-challenge/ {
            root /var/www/html; # Ensure this root is correct for certbot
        }

        # Redirect all other HTTP traffic to HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    

}
    # --- END HTTP to HTTPS Redirect ---

    # --- SERVER BLOCK: Main HTTPS Server for ronautradio.la and its IP ---
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name stream.ronautradio.la 89.117.16.160; # Listen for both domains and IP

        # Using self-signed certificates as per your previous config.
        # If you set up Let's Encrypt, replace these with your fullchain.pem and privkey.pem paths.
    ssl_certificate /etc/letsencrypt/live/stream.ronautradio.la/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/stream.ronautradio.la/privkey.pem; # managed by Certbot
        
        # Commented out these lines as they were causing "No such file or directory" error
        # If you have these files from Certbot, uncomment and ensure paths are correct.
        # include /etc/letsencrypt/options-ssl-nginx.conf;
        # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        # Default root for static files if needed by this server block
        root /var/www/html;

        # Location for the main website content (proxied to Node.js)
        # This assumes your main website is served by Node.js on port 3000
        location / {
            proxy_pass http://localhost:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            # Add CORS if your Node.js app also needs to serve cross-origin content
            # add_header Access-Control-Allow-Origin *;
        }

        # --- PROXY: HLS Stream (matches HTML: https://ronautradio.la/live/hls) ---
        location /live/hls/ { # Trailing slash is important for alias
            # Serve files directly from the directory specified in the rtmp block
            alias /var/www/html/hls/;
            
            # Add comprehensive CORS headers for HLS segments
            add_header Cache-Control no-cache always;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'Range,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type' always;
            add_header Access-Control-Expose-Headers 'Content-Length,Content-Range' always;

            # Handle OPTIONS preflight requests for HLS
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            # Explicitly define content types for HLS files (can be in mime.types, but explicit here is safer)
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
        }
        
        # --- PROXY: "Now Playing" API ---
        # CORS is handled by Flask (flask-cors) â€” do NOT add_header here to avoid duplicates
        location /api/now-playing {
            proxy_pass http://127.0.0.1:5050/now-playing;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: Programme/Schedule API ---
        location /api/programme {
            proxy_pass http://127.0.0.1:5050/programme;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: Play Log API ---
        location /api/play-log {
            proxy_pass http://127.0.0.1:5050/play-log;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: Go Live / Stop Live API ---
        location /api/go-live {
            proxy_pass http://127.0.0.1:5050/go-live;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        location /api/stop-live {
            proxy_pass http://127.0.0.1:5050/stop-live;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: Staff Picks Sets API ---
        location /api/sets {
            proxy_pass http://127.0.0.1:5050/sets;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: VOD Play Tracking API ---
        location /api/vod-play {
            proxy_pass http://127.0.0.1:5050/vod-play;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: VOD Stats API ---
        location /api/vod-stats {
            proxy_pass http://127.0.0.1:5050/vod-stats;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: Residents API ---
        location /api/residents {
            proxy_pass http://127.0.0.1:5050/residents;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- PROXY: Calendar ICS (CORS workaround) ---
        location /api/calendar.ics {
            proxy_pass http://127.0.0.1:5050/calendar.ics;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- STATIC: Resident Photos ---
        location /residents/ {
            alias /var/www/html/residents/;
            add_header Access-Control-Allow-Origin * always;
            add_header Cache-Control "public, max-age=86400" always;

            types {
                image/jpeg jpg jpeg;
                image/png png;
                image/webp webp;
            }
        }

        # --- PROXY: Track ID Submissions ---
        location /api/submit-id {
            proxy_pass http://127.0.0.1:5050/submit-id;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        location /api/submissions {
            proxy_pass http://127.0.0.1:5050/submissions;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        location /api/listeners {
            proxy_pass http://127.0.0.1:5050/listeners;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        # --- STATIC: HLS VOD (large files converted to HLS) ---
        location /hls-vod/ {
            alias /var/www/html/hls-vod/;
            add_header Access-Control-Allow-Origin * always;
            add_header Cache-Control "public, max-age=86400" always;

            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
        }

        # --- STATIC: Staff Picks Thumbnails ---
        location /sets/thumbs/ {
            alias /var/www/html/sets/thumbs/;
            add_header Access-Control-Allow-Origin * always;
            add_header Cache-Control "public, max-age=86400" always;

            types {
                image/jpeg jpg jpeg;
                image/png png;
            }
        }

        # --- STATIC: Staff Picks MP4 files ---
        location /sets/ {
            alias /root/;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
            add_header Accept-Ranges bytes always;

            types {
                video/mp4 mp4;
            }
            default_type application/octet-stream;
        }

        # --- PROXY: Chat WebSocket ---
        location /ws/ {
            proxy_pass http://127.0.0.1:5051/socket.io/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 86400;
        }

        # If stream-test_lp.html is directly served by Nginx (not proxied by Node.js)
        # and you want to access it via https://ronautradio.la/stream-test_lp.html
        location /stream-test_lp.html {
            root /var/www/html;
            try_files $uri =404;
            # Add CORS headers if this file itself needs to be accessed cross-origin
            # add_header Access-Control-Allow-Origin *;
        }
    
}
    # --- END Main HTTPS Server Block ---
}

# (Optional: mail block if you have it)
# mail { ... }